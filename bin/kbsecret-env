#!/usr/bin/env ruby
# frozen_string_literal: true

require "kbsecret"

opts = KBSecret::CLI.slop do |o|
  o.banner = <<~EOS
    Retrieve environment records in a source-able format.

    Usage:
      kbsecret env [--session <name>] [--all] <label1 label2 ...>

    Examples:
      kbsecret env --all
      kbsecret env staging beta
  EOS

  o.string "-s", "--session", "the session name", default: :default
  o.bool "-a", "--all", "retrieve all environment records, not just listed ones"
  o.bool "-v", "--value-only", "print only the environment value, not the key"
end

session = KBSecret::CLI.ensure_session opts[:session]

records = session.records :environment

selected_records = if opts.all?
                     records
                   else
                     records.select do |record|
                       opts.args.include? record.label
                     end
                   end

selected_records.each do |record|
  if opts.value_only?
    puts record.value
  else
    puts record.to_export
  end
end
