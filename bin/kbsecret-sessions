#!/usr/bin/env ruby
# frozen_string_literal: true

require "kbsecret"
require "slop"

opts = Slop.parse suppress_errors: true do |o|
  o.banner = <<~EOS
    List all available sessions.
    The sessions listed can be passed to other commands via the -s flag.

    Usage:
      kbsecret sessions [--show-all]
  EOS

  o.bool "-a", "--show-all", "show each session in depth (i.e. metadata)"

  o.on "-h", "--help" do
    puts o
    exit
  end

  o.on "--introspect-flags" do
    puts o.options.flat_map(&:flags).join "\n"
    exit
  end
end

KBSecret::Config.session_labels.each do |sess_name|
  session_hash = KBSecret::Config.session(sess_name)
  session = KBSecret::Session.new label: sess_name
  line = "#{sess_name}\n"
  line << <<~EOS if opts.show_all?
    \tUsers: #{session_hash[:users].join(", ")}
    \tSecrets root: #{session_hash[:root]} (#{session.directory})
  EOS

  puts line
end
