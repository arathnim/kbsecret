#!/usr/bin/env ruby
# frozen_string_literal: true

require "kbsecret"

include KBSecret

cmd = CLI.new do
  slop do |o|
    o.banner = <<~EOS
      Dump all fields for the given record.

      Usage:
        kbsecret dump-fields [--session <session>] <record>
    EOS

    o.string "-s", "--session", "the session to search in", default: :default
    o.bool "-x", "--terse", "output in field<sep>value format"
    o.string "-i", "--ifs", "separate terse pairs with this string", default: CLI.ifs
  end

  dreck do
    string :label
  end

  ensure_session!
end

session = Session.new label: cmd.opts[:session]
label   = cmd.args[:label]
record  = session[label]

CLI.die "No such record." unless record

field_values = record.class.data_fields.map { |f| record.send f }
field_pairs  = record.class.data_fields.zip(field_values)

if cmd.opts.terse?
  puts field_pairs.map { |f, v| "#{f}#{cmd.opts[:ifs]}#{v}" }.join "\n"
else
  puts field_pairs.map { |f, v| "#{f}: #{v}" }.join "\n"
end
