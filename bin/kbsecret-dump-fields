#!/usr/bin/env ruby
# frozen_string_literal: true

require "kbsecret"
require "slop"

opts = Slop.parse suppress_errors: true do |o|
  o.banner = <<~EOS
    Dump all fields for the given record.

    Usage:
      kbsecret dump-fields [--session <name>] <label>
  EOS

  o.string "-s", "--session", "the session name", default: :default
  o.bool "-x", "--terse", "output in field:value format"
  o.bool "-i", "--ifs", "separate terse pairs with this string", default: ":"

  o.on "-h", "--help" do
    puts o
    exit
  end

  o.on "--introspect-flags" do
    puts o.options.flat_map(&:flags).join "\n"
    exit
  end
end

sess_name = opts[:session]

unless KBSecret::Config.session? sess_name
  abort "Fatal: Unknown session: '#{sess_name}'."
end

session = KBSecret::Session.new label: sess_name

label = opts.args.shift
record = session.records.find { |r| r.label == label }

abort("Fatal: No such record.") unless record

field_values = record.class.data_fields.map { |f| record.send f }
field_pairs = record.class.data_fields.zip(field_values)

if opts.terse?
  puts field_pairs.map { |f, v| "#{f}#{opts[:ifs]}#{v}" }.join "\n"
else
  puts field_pairs.map { |f, v| "#{f}: #{v}" }.join "\n"
end
