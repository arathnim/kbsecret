#!/usr/bin/env ruby
# frozen_string_literal: true

require "kbsecret"

include KBSecret

cmd = CLI.new do
  slop cmds: %w[start suspend complete] do |o|
    o.banner = <<~EOS
      Manage 'to do' records.

      Usage:
        kbsecret todo <start|suspend|complete> <record>

      Examples:
        kbsecret todo start unit-tests
        kbsecret todo suspend laundry
        kbsecret todo complete shopping
    EOS

    o.string "-s", "--session", "the session to search in", default: :default
  end

  dreck do
    string :command
    string :label
  end

  ensure_session!
end

session = Session.new label: cmd.opts[:session]
label   = cmd.args[:label]
todo    = session[label]

CLI.die "No such record." unless todo
CLI.die "'#{todo}' is not a todo record." unless todo.type == :todo

case cmd.args[:command]
when "start"
  CLI.die "That task is already started!" if todo.started?
  todo.start!
  puts "#{todo.label}: '#{todo.todo}' marked as started at #{todo.start}"
when "suspend"
  CLI.die "That task is already suspended!" if todo.suspended?
  todo.suspend!
  puts "#{todo.label}: '#{todo.todo}' marked as suspended at #{todo.stop}"
when "complete"
  CLI.die "That task is already completed!" if todo.completed?
  todo.complete!
  puts "#{todo.label}: '#{todo.todo}' marked as completed at #{todo.stop}"
else
  CLI.die "Unknown action: #{command}."
end
