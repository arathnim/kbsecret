#!/usr/bin/env ruby

require "kbsecret"
require "slop"
require "abbrev"
require "tty-prompt"

# allows for abbreviated types (e.g., `kbsecret new env ...`)
TYPE_ALIASES = Abbrev.abbrev(KBSecret::Record.record_types).freeze

opts = Slop.parse suppress_errors: true do |o|
  o.banner = <<~EOS
    Create a new secret record.

    Usage:
      kbsecret new [--session <name>] [--force] <type> <label> <args ...>
      kbsecret new [--session <name>] [--force] [--interactive] <type> <label>

    Examples:
      kbsecret new login gmail "foo@bar.com" "mytopsecretpassword"
      kbsecret new environment API_KEY "abcdef-0123456789"
      kbsecret new --interactive login netflix
  EOS

  o.string "-s", "--session", "the session name", default: :default
  o.bool "-f", "--force", "force creation (ignore overwrites, etc.)"
  o.bool "-i", "--interactive", "input record fields interactively"
  o.bool "-e", "--echo", "echo input to tty (only effects --interactive)"

  o.on "-h", "--help" do
    puts o
    exit
  end
end

sess_name = opts[:session]

unless KBSecret::Config.session? sess_name
  abort "Fatal: Unknown session: '#{sess_name}'."
end

abort "Fatal: Not enough arguments." if opts.args.size < 2

session = KBSecret::Session.new label: sess_name
type, label = opts.args.shift 2

type = TYPE_ALIASES[type]

if session.record?(label) && !opts.force?
  abort "Fatal: Refusing to overwrite an existing record without --force."
end

unless KBSecret::Record.type?(type)
  abort <<~EOS
    Fatal: Unknown record type: '#{type}'.
    Known types are: #{KBSecret::Record.record_types.join(", ")}.
  EOS
end

fields = []

if opts.interactive?
  prompt = TTY::Prompt.new
  klass = KBSecret::Record.class_for(type)
  klass.data_fields.each do |field|
    fields << prompt.ask("#{field.capitalize}?", echo: opts.echo?)
  end
else
  fields = opts.args
end


begin
  session.add_record(type, label, *fields)
rescue => e
  abort "Fatal: #{e.to_s}."
end
