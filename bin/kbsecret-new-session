#!/usr/bin/env ruby
# frozen_string_literal: true

require "keybase"
require "kbsecret"

include KBSecret

cmd = CLI.new do
  slop do |o|
    o.banner = <<~EOS
      Usage:
        kbsecret new-session [options] --label <label> --root <dir>
    EOS

    o.string "-l", "--label", "the session label"
    o.array "-u", "--users", "the keybase users", default: [Keybase.current_user]
    o.string "-r", "--root", "the secret root directory"
    o.bool "-f", "--force", "force creation (ignore overwrites, etc.)"
  end
end

session_label = cmd.opts[:label]

if Config.session?(session_label) && !cmd.opts.force?
  CLI.die "Refusing to overwrite an existing session without --force."
end

session_hash = {
  users: cmd.opts[:users],
  root: cmd.opts[:root],
}

Config.configure_session(session_label, session_hash)
