#!/usr/bin/env ruby
# frozen_string_literal: true

require "kbsecret"
require "slop"

opts = Slop.parse suppress_errors: true do |o|
  o.banner = <<~EOS
    Stash the given file (or stdin) as an unstructured record.

    Usage:
      kbsecret stash-file <label> [file]

    Example:
      kbsecret stash-file foo ~/foo
      echo "using stdin" | kbsecret stash-file from-stdin
  EOS

  o.string "-s", "--session", "the session name", default: :default

  o.on "-h", "--help" do
    puts o
    exit
  end

  o.on "--introspect-flags" do
    puts o.options.flat_map(&:flags).join "\n"
    exit
  end
end

sess_name = opts[:session]

unless KBSecret::Config.session? sess_name
  abort "Fatal: Unknown session: '#{sess_name}'."
end

session = KBSecret::Session.new label: sess_name
label, filename = opts.args.shift 2

abort("Fatal: Missing a record label to create.") unless label

contents = if filename.nil? || filename == "-"
             STDIN.read
           elsif File.file?(filename)
             File.read(filename)
           else
             abort "Fatal: That file doesn't exist."
           end

session.add_record(:unstructured, label, contents)
