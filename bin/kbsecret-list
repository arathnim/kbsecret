#!/usr/bin/env ruby

require "kbsecret"
require "slop"

opts = Slop.parse suppress_errors: true do |o|
  o.banner = <<~EOS
    List all secrets known to the specified session (or the default session).

    Usage:
      kbsecret list [--session <name>] [--show-all]
  EOS

  o.string "-s", "--session", "the session name", default: :default
  o.string "-t", "--type", "the type of secrets to list", default: nil
  o.bool "-a", "--show-all", "show everything in each secret (i.e. metadata)"

  o.on "-h", "--help" do
    puts o
    exit
  end

  o.on "--introspect-flags" do
    puts o.options.flat_map { |o| o.flags }.join "\n"
    exit
  end
end

sess_name = opts[:session]

unless KBSecret::Config.session? sess_name
  abort "Fatal: Unknown session: '#{sess_name}'."
end

session = KBSecret::Session.new label: sess_name

records = session.records opts[:type]

records.each do |record|
  line = "#{record.label}\n"
  line << <<~EOS if opts.show_all?
    \tType: #{record.type}
    \tLast changed: #{Time.at(record.timestamp)}
    \tRaw data: #{record.data}
  EOS

  puts line
end

